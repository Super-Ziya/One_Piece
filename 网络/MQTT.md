### MQTT

> 物联网传输协议
>
> 轻量级的发布/订阅式消息传输
>
> 为低带宽和不稳定的网络环境中的物联网设备提供可靠的网络服务

- 协议栈：TCP 长链接

- 请求方式：发布订阅

- 消息格式

  <img src="https://img-blog.csdnimg.cn/20190417202546952.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhbmRhb3l1,size_16,color_FFFFFF,t_70" alt="img" style="zoom:50%;" />

- 使用场景：多个客户端通过一个中央代理传递消息的**多对多**协议，通过让客户端发布消息、代理决定消息路由和复制来解耦生产者和消费者
  - HTTP适合使用在性能好一些的终端上，对设备要求相对高一些。不适合M2M的场景
- 防火墙容错：一些企业防火墙将出站连接限制到一些已定义的端口，如 HTTP（80 端口）、HTTPS（443 端口）等。MQTT 可封装在一个 WebSockets 连接中，显示为一个 HTTP 升级请求，从而允许在这些情况下运行
- 特性
  - 使用发布/订阅消息模式，提供一对多的消息发布和应用程序之间的解耦
  - 消息传输不需要知道负载内容
  - 使用 TCP/IP 提供网络连接
  - 有三种消息发布的服务质量：
    - QoS 0：“最多一次”，消息发布完全依赖底层 TCP/IP 网络。分发的消息可能丢失或重复。如，这个等级可用于环境传感器数据，单次数据丢失没关系，因为不久后还会有第二次发送
    - QoS 1：“至少一次”，确保消息可以到达，但消息可能会重复
    - QoS 2：“只有一次”，确保消息只到达一次。如，这个等级可用在一个计费系统中，这里如果消息重复或丢失会导致不正确的收费
  - 小型传输，开销很小（固定长度的头部是 2 字节），协议交换最小化，以降低网络流量
  - 使用 Last Will 和 Testament 特性通知有关各方客户端异常中断的机制
  - 在MQTT协议中，一个MQTT数据包由：固定头（Fixed header）、 可变头（Variable header）、 消息体（payload）三部分构成。MQTT的传输格式非常精小，最小的数据包只有2个bit，且无应用消息头
- 缺点
  - 没有齐备的SDK，不同的异构终端，需要有对应的与MQTT服务器通信的软件SDK包，如MCU、Linux、Android、IOS、WEB等之间要实现互联互通必然需要不同的SDK包
  - 不支持File和AV，有些应用场景，需要传输的信息可能不仅仅限于指令，比如声音信号和视频信号，这些需要通过File和AV来实现通信
  - 不支持与第三方HTTP的集成，虽然MQTT协议优于普通的HTTP协议，但是基于传统的HTTP协议的WEB服务器仍然占主流市场
  - 不支持负载均衡，为防止高并发和恶意攻击，负载均衡服务器也必不可少
  - 不支持用户管理接口，用户在进行设备的行为数据分析的时候，显得尤为重要
  - 不支持离线消息，设备离线以后，MQTT服务器对设备的控制信息丢失问题
  - 不支持点对点通信，采用标准的MQTT协议，理论上可以通过相互订阅的方式实现点对点通信，但是逻辑相对复杂，并且对设备的安全性方面存在担忧。当设备B和设备C在同一主题的情况下，设备A无法知道是设备B还是设备C发送的消息，也有可能消息被设备D窃听
  - 不支持群通信和群管理


