### 计算机网络

#### 1、基础

##### 1.1、分类

- 广域网 WAN（交换技术）
- 城域网 MAN
- 局域网 WAN（广播技术）
- 个人区域网 PAN

##### 1.2、性能指标

- 速率（比特率）：连接在计算机网络上的主机在数字信道上传送数据位数的速率 b、kb、Mb/s 等
- 带宽：原指某信号具有的频带宽度（最高频率与最低频率之差，单位赫兹（Hz）），计网中表示网络通信线路传送数据的能力，指单位时间内从网络某一点到另一点能通过的“最高数据率”，单位比特每秒（传播速率一样（近光速），每微秒发送数据量不同）
- 吞吐量：单位时间内通过某网络（或信道、接口）的数据量，单位b、kb、Mb/s 等，受网络带宽或网络额定速率限制
- 时延：数据（报文、分组、比特流）从网络（或链路）的一端传送到另一端所需的时间，单位 s
  - 发送时延：数据长度/信道带宽（发送速率）
  - 传播时延：信道长度/电磁波传播速度
  - 排队时延：在路由器等待输出/输入链路可用
  - 处理时延：检查错误，找路由转发出口
- 时延带宽积：传播时延 * 带宽，单位 bit（某段链路的比特数）
- RTT（往返时间）：从发送方发送数据到发送方收到接收方的确认经历的时延，包括
  - 往返传播时延
  - 末端处理时间
- 利用率：
  - 信道利用率：有数据通过时间/（有+无）数据通过时间
  - 网络利用率：信道利用率加权平均值

##### 1.3、分层：

- 原则：

  - 各层间相互独立，每层实现一种相对独立功能
  - 每层易于理解，相互交流尽可能少
  - 结构上可分开
  - 保持下层对上层的独立性，上层单向使用下层提供的服务

- 数据结构

  - SDU 服务数据单元：数据
  - PCI 协议控制信息：控制协议操作信息
  - PDU 协议数据单元（下一层的 SDU）：对等层间传送的数据单位，= SDU + PCI

- 7 层 OSI 参考模型（法定标准）

  - 应用层：所有能和用户交互产生网络流量的程序

    > 文件传输（FTP)
    >
    > 电子邮件（SMTP）
    >
    > 万维网（HTTP）

  - 表示层：处理两个通信系统中交换信息的表示方式（语法、语义）

    > 数据格式变换
    >
    > 数据加密解密
    >
    > 数据压缩和恢复（图片、视频）

  - 会话层：向表示层实体/用户进程提供建立连接并在连接上有序地传输数据，建立同步（SYN）

    > 建立、管理、终止会话
    >
    > 使用校验点可使会话在通信失效时从校验点、同步点继续恢复通信，实现数据同步（传输大文件）

  - 传输层：负责主机中两个进程的通信（端到端通信），传输单位是报文段、用户数据报

    > 可靠传输、不可靠传输
    >
    > 差错控制
    >
    > 流量控制
    >
    > 复用分用：端口号区分不同进程
    >
    > 复用：多个应用层进程可同时使用下面运输层的服务
    >
    > 分用：运输层把收到的信息分别交付给上面应用层中相应进程

  - 网络层：把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务，传输单位是数据报

    > 路由选择，最佳路径
    >
    > 流量控制
    >
    > 差错控制
    >
    > 拥塞控制：若所有结点都来不及接受分组而要丢弃大量分组时，网络就处于拥塞状态

  - 数据链路层：把网络层的数据报组装成帧，传输单位是帧

    > 成帧：定义帧的开始和结束
    >
    > 差错控制：帧错、位错
    >
    > 流量控制
    >
    > 访问（接入）控制控制对信道的访问

  - 物理层：在物理媒体上实现比特流的透明传输，传输单位是比特

    > 透明传输：不管所传数据的比特组合，都能在链路上传送
    >
    > 定义接口特性
    >
    > 定义传输模式：单工、半双工、全双工
    >
    > 定义传输速率
    >
    > 比特同步
    >
    > 比特编码

  - 前 3 资源子网（数据处理），后 3 通信子网（数据通信）

  - 前 4 端到端，后 3 点到点

- 5层参考模型：综合 OSI 和 TCP/IP 的优点

  - 应用层：支持各种网络应用，协议：FTP、SMTP、HTTP

  - 传输层：进程-进程的数据传输，协议：TCP、UDP
  - 网络层：源主机到目的主机的数据分组路由与转发，协议：IP、 ICMP、 SF
  - 数据链路层：把网络层传下来的数据报组装成帧，协议：Ethernet、PPP
  - 物理层：比特传输

- 4 层 TCP/IP 参考模型（事实标准）

  - 应用层
  - 传输层
  - 网际层
  - 网络接口层

#### 2、物理层

> 解决如何在连接各种计算机的传输媒体上传输数据比特流，不是指具体传输媒体
>
> 主要任务：确定与传输媒体接口有关的一些特性定义标准

##### 2.1、标准

- 机械特性：物理连接特性，规定物理连接时采用的规格、接口形状、引线数目、引脚数量、排列情况
- 电气特性：规定传输二进制位时，线路上信号的电压范围、阻抗匹配、传输速率、距离限制等
- 功能特性：指明某条线上出现的某一电平表示何种意义，接口部件的信号线的用途
- 规程特性：定义各条物理线路的工作规程和时序关系

##### 2.2、通信方式

- 单工通信：只有一个方向的通信，没有反方向的交互，仅需一条信道
- 半双工通信：通信双方都可发送或接收信息，但任一方不能同时发送和接收，需要两条信道
- 全双工通信：通信双方可同时发送和接受信息，需要两条信道

##### 2.3、传输方式

- 串行传输：速度慢，费用低，适合远距离
- 并行传输：速度快，费用高，适合近距离，用于计算机内部数据传输

##### 2.4、专业名词

- 码元：用一个固定时长的信号波形（数字脉冲）代表不同离散数值基本波形，数字通信中数字信号的计量单位，该信号称 k 进制码元，该时长称码元宽度，当码元离散状态 M 个（M 大于 2），此时码元为 M 进制码元，对应有 M 种高低不同的波形
  - 1 码元可携带多比特信息量，如使用二进制编码只有两种不同码元，一种代表 0 状态，一种代表 1
- 速率：单位时间内传输的数据量
  - 码元传输速率：单位时间内数字通信系统传输的码元个数（脉冲个数、信号变化次数)，单位波特 Baud，1 波特表示数字通信系统每秒传输一个码元（可多进制）
  - 信息传输速率：单位时间内数字通信系统传输的二进制码元个数（比特数），单位比特/秒（b/s）
  - 关系：若一码元携带 n bit 信息量，则 M Baud 码元传输速率所对应信息传输速率为 M*n bit/s
- 带宽：单位时间内从网络中某一点到另一点所能通过的“最高数据率”，单位 b/s

##### 2.5、失真

- 影响因素：
  - 码元传输速率
  - 信号传输距离
  - 噪声干扰
  - 传输媒体质量
- 码间串扰：接收端收到的信号波形失去了码元间清晰界限的现象
- 奈奎斯特定理（内忧，理想情况）：理想低通（无噪声、带宽受限），为避免码间串扰，极限码元传输速率为 2W Baud
  - W：信道带宽，单位 Hz
  - 极限数据传输速率：$2Wlog_2V$ 
  - 任何信道中，码元传输速率有上限。超过此上限会出现严重的码间串扰
  - 信道频带越宽（能通过的信号高频分量越多），可用更高速率进行码元有效传输
  - 码元传输速率受奈氏准则制约，要提高数据传输速率，要使每个码元能携带更多个比特的信息量，要采用多元制调制方法
- 香农定理（外患，噪声影响）：在带宽受限且有噪声的信道中，为不产生误差，信息数据传输速率有上限
  - 极限数据传输速率：$Wlog_2(1+S/N)$ 
  - 信噪比：信号平均功率/噪声平均功率，S/N，分贝（dB）为度量单位
  - 信道带宽或信噪比越大，信息的极限传输速率就越高，一定的传输带宽和信噪比，信息传输速率的上限已确定
  - 只要信息传输速率低于信道极限传输速率，就能找到某种方法实现无差错传输

##### 2.6、编码与调制

- 信道：信号的传输媒介。一条通信线路往往包含一条发送信道和一条接收信道

  - 模拟信道（传送模拟信号）/ 数字信道（传送数字信号)

  - 无线信道 / 有线信道

  - 基带信号：将数字信号 1/0 用两种不同电压表示，送到数字信道上传输。来自信源的信号，像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号。基带信号直接表达要传输的信息信号，如说话的声波

  - 宽带信号：将基带信号调制后形成的频分复用模拟信号，送到模拟信道上传输。把基带信号经载波调制后，把信号的频率范围搬移到较高频段以便在信道中传输（仅在一段频率范围内能够通过信道）

    > 传输距离较近：采用基带传输方式（近距离衰减小，信号内容不易发生变化）
    >
    > 传输距离较远：采用宽带传输方式（远距离衰减大，即使信号变化大也能过滤出基带信号）

- 编码：数据 - 数字信号

  - 采样定理：$f_{采样频率}>=2f_{信号最高频率}$ 

- 调制：数据 - 模拟信号

  | 编码调制 | 数字信号                                                     | 模拟信号         |
  | -------- | ------------------------------------------------------------ | ---------------- |
  | 数字数据 | 非归零编码NRZ：高1低0，无检错、难同步<br />归零编码RZ：信号电平在一个码元内都恢复到0<br />曼彻斯特编码：前高后低1，前低后高0，中间跳变可作为时钟信号（自同步），数据传输速率只有调制速率1/2<br />差分曼彻斯特编码：同1异0，自同步，抗扰性强 | 调幅、调频、调相 |
  | 模拟数据 | 抽样：对模拟信号周期性扫描，把时间上连续的信号变成时间上离散的信号<br />量化：把抽样取得的电平幅值按一定分级标度转化为对应数字值，取整数<br />编码：把量化结果转换为与之对应的二进制编码 | 频分复用         |

##### 2.7、设备

- 中继器：对数字信号进行再生和还原（模拟信号用放大器），对衰减信号进行放大，保持与原数据相同，增加信号传输距离，延长网络长度
  - 解决：由于存在损耗，在线路上传输的信号功率会逐渐衰减，到一定程度造成信号失真，导致接收错误
  - 两端：两端的网络部分是网段，不是子网，适用于完全相同的两类网络互连，且两网段速率相同。只将任何电缆段上的数据发送到另一段电缆上，仅作用于信号电气部分，不检错，不存储转发
  - 5-4-3 规则：五个网段，最多四个中继器，只有三个段可挂接计算机
- 集线器（多口中继器）：对信号进行再生放大转发，对衰减信号进行放大，转发到其他（除输入端口外）处于工作状态的端口上，以增加信号传输距离，延长网络长度。不具备信号定向传送能力，是共享式设备，星型拓扑
  - 是一个完整冲突域，不能分割冲突域，集线器上的主机平分带宽

#### 3、数据链路层

> 在物理层提供服务的基础上向网络层提供服务，将源自网络层的数据可靠地传到相邻节点的目标机网络层
>
> 作用：加强物理层传输原始比特流功能，将物理层提供的可能出错的物理连接改造成为逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路

##### 3.1、基本概念

- 节点：主机、路由器
- 链路：网络中两结点间的物理通道
- 数据链路：网络中两结点间的逻辑通道
- 帧：数据链路层的协议数据单元，封装网络层数据报

##### 3.2、功能

- 为网络层提供服务。无确认无连接服务，有确认无连接服务，有确认面向连接服务
- 链路管理。连接的建立、维持、释放（面向连接的服务）
- 组帧（发送方）：在数据前后添加首部尾部，标记帧的开始和结束，确定帧的界限
  - 帧同步（接收方）
  - 透明传输：不管所传数据是什么比特组合，都能在链路上传送
- 流量控制（发送方）

##### 3.3、差错控制：由噪声引起

- 位错：1变成0，0变成1
- 帧错：丢失、重复、失去
- 检错：奇偶校验码（检错能力50%）、循环冗余码CRC
- 纠错：海明码

##### 3.4、流量控制：

- 数据链路层： 接收方收不下就不回复确认

- 传输层：接收端给发送端一个窗口公告

- 停止-等待协议（窗口=1）：每发送完一个帧就停止发送，等待对方确认，收到确认后再发送下一帧

  - 超时计时器：每次发送一个帧启动启动计时，重传时间比RTT长一些
  - 发完一个帧后保留其副本，待收到确认帧后可丢弃
  - 数据帧和确认帧编号
  - 简单，信道利用率低

- 滑动窗口协议：

  - 后退 N 帧协议（GBN）：发送窗口>1，接收窗口=1

    > 累计确认，有批量重传的问题，一个帧出错，之后的帧都可能要重传

  - 选择重传协议（SR）：发送窗口>1，接收窗口>1

    - 发送端：
    
    > 上层调用：从上层收到数据后，发送方检查下一帧序号，如果位于发送窗口内，则发送数据帧，否则像 GBN 一样，将数据缓存或返回给上层后再传输
    >
    > 收到 ACK：如果该帧序号在窗口内，发送方将该帧标记为已接收。如果序号是窗口下界（最左边窗口对应序号），窗口向前移动到具有最小序号的未确认帧处。如果窗口移动且有序号在窗口内的未发送帧，则发送这些帧
    >
    > 超时：每个帧都有自己的定时器，超时后只重传一个帧
    
    - 接收端：
    
    > 来者不拒（窗口内）：确认一个正确接收的帧，不管是否按序。失序帧将被缓存，并返回发送方一个该帧的确认帧，直到所有帧（序号更小的帧）皆被收到为止，才可将一批帧按序交付给上层，然后向前移动滑动窗口
    >
    > 如果收到窗口序号外的帧，返回一个 ACK，其他情况忽略该帧

##### 3.5、链路

- 点对点链路：两相邻节点通过一个链路相连，无第三者
  - 应用：PPP 协议，常用于广域网
- 广播室链路：所有主机共享通信介质
  - 应用：早期总线以太网、无线局域网，常用于局域网
  - 拓扑结构：总线型、星型

##### 3.6、介质访问控制：采取一定措施，使两对节点间通信不互相干扰

- 静态划分信道

  > 多路复用：多信号组合在一条物理信道上传输，使多个计算机或终端设备共享信道资源，提高信道利用率，逻辑上把广播信道变成点对点信道

  - 频分多路复用 FDM（并行）：用户分配一定的频带，所有用户同时占用不同带宽（频率带宽）资源

    - 充分利用传输介质带宽
    - 系统效率较高
    - 技术比较成熟，实现比较容易
    
  - 时分多路复用 TDM（并发）：将时间划分为一段段等长的时分复用帧（TDM 帧，物理层划分）。每一用户在每个 TDM 帧中占用固定序号的时隙，所有用户轮流占用信道

  - 统计时分复用 STDM：每个 STDM 帧中的时隙数小于连接在集中器上的用户数。用户有数据就随时发往集中器的输入缓存，集中器按顺序把缓存中的输入数据放入 STDM 帧中，一个 STDM 帧满了就发出

    > STDM 帧按需动态分配时隙

  - 波分多路复用 WDM：光的频分多路复用，一根光纤中传输多种不同波长（频率）的光信号，由于波长（频率）不同，各路光信号互不干扰，最后用波长分解复用器将各路波长分解出来

  - 码分多路复用 CDM：

    - 码分多址 CDMA：1 比特分为多码片/芯片，每一站点指定唯一 m 位芯片序列，发送 1 时站点发送芯片序列，发送 0/-1 时发送芯片序列反码
  - 不冲突：多站点同时发送数据时，要求各站点芯片序列相互正交
    - 合并：各路数据在信道中线性相加
    - 分离：合并的数据和源站规格化内积（对应位相乘之和除以位数）
  
- 动态分配信道

  - 轮询：令牌传递协议：主结点轮流“邀请”从结点发送数据

    - 问题：轮询开销、等待延迟、单点故障（主节点）
    - 令牌：一个特殊格式的 MAC 控制帧，不含信息，控制信道使用，确保同一时刻只有一个结点独占信道，令牌环网无碰撞
    - 每结点都可在一定时间内（令牌持有时间）获得发送数据权利，不是无限制持有令牌
    - 适用：负载较重、通信量较大的网络
    
  - 随机访问：

    - ALOHA 协议（不听就说）：不监听信道，不按时间槽发送，随机重发。发生冲突，接收方会检错，不予确认，发送方在一定时间内收不到就判断发生冲突，超时后等一随机时间重传

    - 时隙 ALOHA 协议：把时间分成若干相同时间片，用户在时间片开始时同步接入网络信道，发生冲突必须等到下一个时间片开始时再发送

    - 载波监听多路访问 CSMA 协议（先听再说）：

      > 坚持 CSMA：发送消息前先监听信道，空闲直接传输，忙则一直监听，直到空闲传输，冲突（一段时间内未收到肯定回复）则等待一随机时间再监听
      >
      > - 优点：媒体空闲，站点发送，避免媒体利用率的损失
      > - 缺点：如有两个或两个以上站点数据发送，冲突不可避免
      >
      > 非坚持 CSMA：发送消息前先监听信道，空闲直接传输，忙则等待一随机时间后再监听
      >
      > - 优点：随机的重发时间可减少冲突发生可能
      > - 缺点：存在延迟等待过程中，媒体处于空闲状态，媒体使用率降低
      >
      > p-坚持 CSMA：发送消息前先监听信道，空闲以 p 概率传输，概率 1-p 等到下一时间槽传输，忙则等待一随机时间后再监听
      >
      > - 优点：像非坚持一样减少冲突，像坚持一样减少媒体空闲时间
      > - 缺点：发生冲突后还要把数据帧发完，造成浪费

      |      | 坚持 CSMA | 非坚持 CSMA          | p-坚持 CSMA                      |
      | ---- | --------- | -------------------- | -------------------------------- |
      | 空闲 | 马上发    | 马上发               | p概率发<br />1-p概率等下一时隙发 |
      | 忙   | 继续监听  | 放弃监听，等随机时间 | 放弃监听，等随机时间             |

    - 载波监听多路访问/碰撞检测 CSMA/CD 协议（先听再说，边听边说）：

      > 争用期/冲突窗口/碰撞窗口：两倍总线端到端传播时延（2T）
      >
      > 二进制指数规避算法：基本退避时间 = 争用期 2T，重传次数 = min(重传次数, 10)，重传退避时间 = rank(0, 2^k-1)，最大重传次数 16
      >
      > 最小帧长：2T * 数据传输速率

    - 载波监听多路访问/碰撞避免 CSMA/CA 协议

      > 发送数据前先检测信道是否空闲，空闲发出 RTS，包括发射端地址、接收端地址、下一份数据持续发送的时间等信息，忙则等待
      >
      > 接收端收到 RTS 后响应 CTS，发送端收到 CTS 后开始发送数据帧，同时预约信道（发送方告知其他站点自己要传多久数据）
      >
      > 接收端收到数据帧后，用 CRC 检验数据，正确则响应 ACK 帧
      >
      > 发送方收到 ACK 就可进行下一数据帧的发送，没有则一直重传至规定重发次数为止（采用二进制指数退避算法确定随机推迟时间）

    - CSMA/CD 和 CSMA/CA

      > 相同：都从属 CSMA，核心先听再说
      >
      > 不同：
      >
      > - 传输介质不同：CSMA/CD 用于总线式以太网（有线），CSMA/CA 用于无线局域网（无线）
      > - 载波检测方式不同：CSMA/CD 通过电缆中电压变化检测，当数据发生碰撞时电缆中电压会发生变化，CSMA/CA 采用能量检测、载波检测、能量载波混合检测
      > - CSMA/CD 检测冲突，CSMA/CA 避免冲突，冲突后都会上限的重传

##### 3.7、局域网：LAN，指某一区域内由多台计算机互联成的计算机组，使用广播信道

- 特点：
  - 覆盖地理范围较小，如一座或集中的建筑群内
  - 使用专门铺设的传输介质（双绞线、同轴电缆）进行联网，数据传输速率高（10Mb/s~10Gb/s)
  - 通信延迟时间短，误码率低，可靠性较高
  - 各站平等，共享传输信道
  - 多采用分布式控制和广播式通信，能进行广播和组播
- 网络拓扑：星型、总线型、环型、树型
- 介质访问控制：
  - CSMA/CD：常用于总线型局域网，也用于树型网络
  - 令牌总线：常用于总线型局域网，也用于树型网络。把总线型或树型网络中各工作站按一定顺序，如接口地址大小排列，形成一个逻辑环，只有令牌持有者才能控制总线，发送信息的权力
  - 令牌环：用于环形局域网，如令牌环网
- IEEE 802标准：描述局域网参考模型，对应 OSI 参考模型的数据链路层与物理层，将数据链路层划分为逻辑链路层 LLC 子层和介质访问控制 MAC 子层
  - LLC：负责识别网络层协议，进行封装。为网络层提供服务：无确认无连接、面向连接、带确认无连接、高速传送
  - MAC：数据帧的封装/卸装，帧的寻址和识别，帧的接收与发送，链路的管理，帧的差错控制等。MAC 子层屏蔽了不同物理链路种类的差异性

##### 3.8、广域网：WAN，跨接很大物理范围，能连接多个城市或国家，或横跨几个洲并能提供远距离通信，形成国际性远程网络

- 广域网通信子网主要使用分组交换技术，利用公用分组交换网、卫星通信网、无线分组交换网，将分布在不同地区的局域网或计算机系统互连，达到资源共享。因特网是世界范围内最大的广域网

- 和局域网区别：

  - 广域网覆盖网络层、数据链路层、物理层
  - 局域网覆盖数据链路层、物理层

- 点对点 PPP 协议：只支持全双工，面向字节，不可靠（无序号、确认机制），满足透明传输

  - 一个将 IP 数据报封装到串行链路（同步/异步串行）的方法
  - 链路控制协议 LCP：建立、维护数据链路连接，身份验证
  - 网络控制协议 NCP：PPP 支持多种网络层协议，不同协议要一个相应 NCP 配置，为网络层协议建立和配置逻辑连接

- 高级数据链路控制 HDLC 协议：只支持全双工，面向比特，可靠（有编号、确认机制，速度慢），满足透明传输

  - 主站：发送命令（包括数据信息）帧、接收响应帧，负责对整个链路控制系统的初启、流程控制、差错检测、恢复等
  - 从站：接收由主站发来的命令帧，向主站发送响应帧，配合主站参与差错恢复等链路控制
  - 复合站：能发送、接收命令帧和响应帧，负责整个链路的控制

##### 3.9、设备

- 网桥：根据 MAC 帧目的地址对帧进行转发和过滤。收到一个帧时不向所有接口转发此帧（集线器无脑转发），先检查此帧的目的 MAC 地址再确定转发到哪一接口，或丢弃（过滤）

  - 优点：

    - 分割冲突域
    - 过滤通信量，增大吞吐量
    - 扩大物理范围
    - 提高可靠性
    - 可互连不同物理层、MAC 子层、速率的以太网
    
  - 透明网桥：“透明”指以太网上站点不知所发送的帧将经过几个网桥，自学习算法（转发表）
  
  - 源路由网桥：发送帧时把详细最佳路由信息（路由最少/时间最短）放在帧首部中

    > 方法：源站以广播方式向欲通信的目的站发送一个发现帧

- 交换机（多接口网桥）：

  - 直通式交换机：查完目的地址立刻转发

    > 延迟小，可靠性低，不支持不同速率端口的交换

  - 存储转发式交换机：将帧放入高速缓存，检查否正确，正确则转发，错误则丢弃

    > 延迟大，可靠性高，支持不同速率端口的交换

- 冲突域：同一冲突域中每个节点都能收到所有被发送的帧，同一时间只有一台设备发送信息的范围

- 广播域：网络中能接收任一设备发出的广播帧的所有设备集合。站点发出一个广播信号，所有能收到信号的设备范围

  |                              | 能否隔离冲突域 | 能否隔离广播域 |
  | :--------------------------: | :------------: | :------------: |
  | 物理层设备（中继器、集线器） |       ×        |       ×        |
  |  链路层设备（网桥、交换机）  |       √        |       ×        |
  |     网络层设备（路由器）     |       √        |       √        |

#### 4、网络层

> 把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务，传输单位数据报

##### 4.1、功能

- 路由选择、分组转发（最佳路径）
- 异构网络互联
- 拥塞控制：若所有结点来不及接受分组要丢弃大量分组时，网络处于拥塞状态

##### 4.2、交换

- 电路交换：电话网络
  - 优点：通信时延小、有序传输、没有冲突、实时性强
  - 缺点：建立连接时间长、线路独占，使用效率低、灵活性差、无差错控制能力
- 报文交换：源应用发送的信息整体
  - 优点：无需建立连接、存储转发，动态分配线路、线路可靠性较高、线路利用率较高、多目标服务
  - 缺点：有存储转发时延、报文大小不定，需网络节点有较大缓存空间
- 分组交换：分组：把大数据块分割成小数据块
  - 优点：无需建立连接、存储转发，动态分配线路、线路可靠性较高、线路利用率较高、相对于报文交换，存储管理更容易
  - 缺点：有存储转发时延、需要传输额外信息量、乱序到目的主机时，要对分组排序重组
- 数据报方式：
  - 提供无连接服务：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同
- 虚电路方式：将数据报和电路交换方式结合，一条源主机到目的主机的逻辑连接，路径上所有结点要维持虚电路的建立，维持一张虚电路表，每一项记录一个打开的虚电路信息
  - 每个分组携带虚电路号，而非目的地址
  - 提供连接服务：为分组的传输确定传输路径（建立连接），沿该路径（连接）传输系列分组，系列分组传输路径相同，传输结束后拆除连接

##### 4.3、路由算法：

- 静态路由算法（非自适应路由算法）：管理员手工配置路由信息
  - 简便可靠，在负荷稳定、拓扑变化不大的网络中运行效果好，广泛用于高度安全性的军事网络和较小的商业网络
  - 路由更新慢，不适用大型网络
- 动态路由算法（自适应路由算法）：路由器间彼此交换信息，按路由算法优化出路由表项
  - 路由更新快，适用大型网络，及时响应链路费用或网络拓扑变化
  - 算法复杂，增加网络负担
  - 全局性，链路状态路由算法 OSPF：所有路由器掌握完整的网络拓扑和链路费用信息
  - 分散性，距离向量路由算法 RIP：路由器只掌握物理相连的邻居及链路费用

##### 4.4、路由选择协议：

- 自治系统 AS：在单一技术管理下的一组路由器，这些路由器使用一种 AS 内部的路由选择协议和共同的度量确定分组在该 AS 内的路由，使用一种 AS 间的路由协议确定在 AS 间的路由
- 一个 AS 内所有网络都属于一个行政单位管辖，一个自治系统所有路由器在本自治系统内都必须连通

- 内部网关协议 IGP：一个 AS 内使用，RIP、OSPF
- 外部网关协议 EGP：AS 间使用，BGP

##### 4.5、TCP/IP 协议栈

![计网_tcpip协议栈](图片.assets\计网_tcpip协议栈.jpg)

- IP 数据报格式

  - 最大传送单元 MTU：数据链路层帧可封装数据上限，超过要分片
  - 生存时间 TTL：IP 分组保质期，经过一个路由 -1，变成 0 丢弃
  - 协议：数据对应协议（TCP：6，UDP：17）
  - 标识：同一数据报的分片用同一标识
  - 标志：只有两位有意义，中间位 DF，为 1 禁止分片，为 0 允许，最低位 MF，为 1 后面还有分片，为 0 代表最后一片
  - 片偏移：指出较长分组分片后，某片在原分组中的相对位置

  ![计网_ip数据报格式](C:\Users\13085\Desktop\One_Piece\网络\图片.assets\计网_ip数据报格式.jpg)

##### 4.6、IPv4：

- IP 地址：全世界唯一的 32位/4字节 标识符，标识路由器主机的接口，网络号 + 主机号

- 分类

  ![计网_IPv4分类](图片.assets\计网_IPv4分类.jpg)

- 特殊 IP 地址

  | 网络号 | 主机号  | 作为IP分组源地址 | 作为IP分组目的地址 | 用途                                                         |
  | ------ | ------- | ---------------- | ------------------ | ------------------------------------------------------------ |
  | 全0    | 全0     | 可               | 不可               | 本网范围内表示主机，路由表中用于表示默认路由（整个Internet网络） |
  | 全0    | 特定值  | 不可             | 可                 | 表示本网内某个特定主机                                       |
  | 全1    | 全1     | 不可             | 可                 | 本网广播地址（路由器不转发）                                 |
  | 特定值 | 全0     | 不可             | 不可               | 网络地址，表示一个网络                                       |
  | 特定值 | 全1     | 不可             | 可                 | 直接广播地址，对特定网络上所有主机进行广播                   |
  | 127    | 非全0/1 | 可               | 可                 | 用于本地软件换回测试，称环回地址                             |

- 私有 IP 地址

  - 路由器对目的地址是私有 IP 地址的数据报不转发
  - 网络地址转换 NAT：在专用网连接到因特网的路由器上安装 NAT 软件，为 NAT 路由器，至少有一个有效外部全球 IP 地址
  - NAT 转换表：WAN 端和 LAN 端一一对应 

  | 地址类别 | 地址范围                    | 网段个数 |
  | -------- | --------------------------- | -------- |
  | A类      | 10.0.0.0~10.255.255.255     | 1        |
  | B类      | 172.16.0.0~172.31.255.255   | 16       |
  | C类      | 192.168.0.0~192.168.255.255 | 256      |

##### 4.7、子网划分

- 主机号 -- 子网号 + 主机号（不能全 0 全 1）
- 某单位划分子网后，对外仍表现为一个网络
- 子网掩码：网络号全为 1，主机号全为 0
  - 子网掩码与 IP 地址逐位相与，得子网网络地址
- 无分类编址 CIDR
  - 网络前缀 -- 网络号  / 网络号 + 子网号
  - 记法：IP 地址后加上 “/”，写上网络前缀（任意长度）位数，如 128.14.32.0/20
  - 融合子网地址与子网掩码，方便子网划分。把网络前缀相同的连续 IP 地址组成一个 CIDR 地址块
  - 构成超网：将多个子网聚合成一个较大子网，方法：将网络前缀缩短
  - 使用 CIDR 时，查找路由表可能得到几个匹配结果，应选择最长网络前缀的路由。前缀越长，地址块越小，路由越具体

##### 4.7、ARP 协议

- ARP 高速缓存：IP 地址与 MAC 地址的映射
- 数据链路层使用 MAC 地址
- 广播 ARP 请求分组：IP1 + IP2（广播域内目的主机，广播域外默认网关） + MAC1 + FF-FF-FF-FF-FF-FF
- 单播 ARP 响应分组：IP2 + MAC2
- 使用：
  - 检查 ARP 高速缓存，有对应表项则写入 MAC 帧，没有则用目的 MAC 地址为 FF-FF-FF-FF-FF-FF 的帧封装并广播 ARP 请求分组，同一局域网中所有主机都能收到该请求。目的主机收到请求后就会向源主机单播一个 ARP 响应分组，源主机收到后将此映射写入 ARP 缓存（10-20min 更新一次）

##### 4.8、DHCP 协议

- 主机获取 IP 地址

  - 静态配置

    > IP 地址
    >
    > 子网掩码
    >
    > 默认网关：子网内与外界交换数据的统一路由器接口

  - 动态配置

    > DHCP：应用层协议，使用客户/服务器方式，通过广播方式进行交互，基于 UDP
    >
    > 提供即插即用联网机制，主机可从服务器动态获取 IP 地址、子网掩码、默认网关、DNS 服务器名称与 IP 地址，允许地址重用，支持移动用户加入网络，支持在用地址续租

- 使用

  - 主机广播 DHCP 发现报文：试图找到网络中的服务器，服务器获得一个 IP 地址
  - DHCP 服务器广播 DHCP 提供报文：服务器拟分配给主机一个 IP 地址及相关配置，先到先得
  - 主机广播 DHCP 请求报文：主机向服务器请求提供 IP 地址
  - DHCP 服务器广播 DHCP 确认报文：正式将 IP 地址分配给主机

##### 4.9、网际控制报文协议 ICMP 协议

> 网络层协议，作为 IP 数据报的数据部分

- ICMP 差错报文
  - 终点不可达：路由器或主机不能交付数据报时，向源点发送终点不可达报文
  - （不再使用）源点抑制：路由器或主机由于拥塞而丢弃数据报时，向源点发送源点抑制报文，使源点把数据报发送速率放慢
  - 时间超过：路由器收到生存时间 TTL=0 的数据报时，丢弃该数据报，向源点发送时间超过报文。终点在预先规定时间内不能收到一个数据报全部数据报片时，把已收到数据报片都丢弃，向源点发送时间超过报文
  - 参数问题：路由器或目的主机收到的数据报首部中有的字段值不正确时，丢弃该数据报，向源点发送参数问题报文
  - 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机下次应将数据报发送给另外的路由器（可通过更好的路由）
- 不发送 ICMP 差错报文
  - 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文（ICMP 差错报文出错）
  - 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文
  - 对具有组播地址的数据报都不发送 ICMP 差错报告报文
  - 对具有特殊地址（如 127.0.0.0）的数据报不发送 ICMP 差错报告报文
- ICMP 询问报文
  - 回送请求和回答报文：主机或路由器向特定目的主机发出的询问，收到此报文的主机必须给源主机或路由器发送 ICMP 回送回答报文，测试目的站是否可达及了解其相关状态
  - 时间戳请求和回答报文：请某主机或路由器回答当前日期时间，用来进行时钟同步和测量时间
  - （不再使用）掩码地址请求和回答报文
  - （不再使用）路由器询问和通告报文
- 应用
  - PING：测试两个主机的连通性，使用 ICMP 回送请求和回答报文
  - Traceroute：跟踪一个分组从源点到终点的路径，使用 ICMP 时间超过差错报告报文（报文的 TTL 逐渐增加到可达目的主机）

##### 4.10、IPv6

- 优先级：区分数据报的类别和优先级
- 流：互联网上从特定源点到特定终点的一系列数据报，所有属于同一流的数据报都具有同样流标签
- 下一个首部：标识下一个扩展首部或上层协议首部
- 跳数限制：相当于 IPv4 的 TTL

![计网_IPv6](图片.assets\计网_IPv6.jpg)
- 和 IPv4 区别
  - IPv6 将地址从 32 位（4B，点分十进制）扩大到 128 位（16B，冒号十六进制），
  - IPv6 将 IPv4 校验和字段移除，减少每跳处理时间
  - IPv6 将 IPv4 可选字段移出首部，变成扩展首部，路由器通常不对扩展首部进行检查，大大提高路由器处理效率
  - IPv6 支持即插即用（自动配置 IP），不需 DHCP 协议
  - IPv6 首部长度必须是 8B 整数倍，IPv4 首部是 4B 整数倍
  - IPv6 只能在主机处分片，IPv4 可在路由器和主机处分片
  - ICMPv6：附加报文类型“分组过大”
  - IPv6 支持资源预分配，支持实时视像等，保证一定带宽和时延的应用
  - IPv6 取消协议字段，改成下一个首部字段
  - IPv6 取消总长度字段，改用有效载荷长度字段
  - IPv6 取消服务类型字段
- 地址压缩：
  - 4BF5:0000:0000:0000:BA5F:039A:000A:2176 -- 4BF5:0:0:0:BA5F:39A:A:2176
  - FF05:0:0:0:0:0:0:B3 -- FF05::B3，双冒号表示法在一个地址中仅可出现一次
- 地址类型
  - 单播：一对一通信，可做源地址、目的地址
  - 多播：一对多通信，可做目的地址
  - 任播：一对多中的一个通信
- IPv6 过渡向 IPv4
  - 双栈协议：在一台设备（路由器、计算机）上同时启用 IPv4 协议栈和 IPv6 协议栈，能和 IPv4、IPv6 网络通信
  - 隧道技术：通过使用互联网络基础设施在网络间传递数据。隧道传递数据（或负载）可是不同协议数据帧或包。隧道协议将其它协议数据帧或包重新封装后通过隧道发送

##### 4.11、距离向量路由算法 RIP 协议

> 应用层协议，使用 UDP，适用于小互联网
>
> 分布式的基于距离向量的路由选择协议，因特网协议标准，优点简单
>
> 要求网络中每个路由器都维护从其到其他每个目的网络的唯一最佳距离记录（一组距离）
>
> 一个 RIP 报文最多可包括 25 个路由，超过再用一个 RIP 报文传送

- 距离、跳数：从源端口到目的端口经过的路由器个数，经过一个路由器跳数 +1，从一路由器到直接连接的网络距离为 1
  
- RIP 允许一条路由最多包含 15 个路由器，距离为 16 表示网络不可达
  
- 交换

  - 仅和相邻路由器交换信息
  - 交换信息是路由表
  - 每 30 秒交换一次路由信息，路由器根据新信息更新路由表，若超过 180s 没收到邻居路由器通告，判定邻居没了，更新路由表
  - 路由器刚开始工作时只知道直接连接的网络距离（距离为 1），每个路由器只和数目有限的相邻路由器交换并更新路由信息
  - 经过若干次更新后，所有路由器都知道到达本自治系统任一网络的最短距离和下一跳路由器地址

- 距离向量算法：

  > Net3 -- R2 -- Net2 -- x -- Net1 -- R1

  - 修改相邻路由器发来的 RIP 报文中所有表项：对地址为 x 的相邻路由器发来的 RIP 报文，修改此报文：把“下一跳”字段地址改为 x，把所有“距离”字段 +1

  - 对修改后的 RIP 报文中每个项目：

    - R1 路由表中若没有 Net3，把该项目填入 R1 路由表

    - R1 路由表中若有 Net3，查看下一跳路由器地址：

      > 若下一跳是 x，用收到的项目替换源路由表中的项目
      >
      > 若下一跳不是 x，原来距离比从 x 走的距离远则更新，否则不作处理

  - 若 180s 还没收到相邻路由器 x 的更新路由表，把 x 记为不可达路由器（距离设为 16）

  - 返回

- 例：根据 R4 发来的路由更新信息，更新 R6 路由表

  |      | 目的网络 | 距离 | 下一跳   |
  | ---- | -------- | ---- | -------- |
  | R6   | Net2     | 3    | R4       |
  |      | Net3     | 4    | R5       |
  |      |          |      |          |
  | R4   | Net1     | 3    | R1       |
  |      | Net2     | 4    | R2       |
  |      | Net3     | 1    | 直接交付 |

  - 先更新 R4，再对比 R6

  |          | 目的网络 | 距离 | 下一跳 |
  | -------- | -------- | ---- | ------ |
  | R4修改版 | Net1     | 4    | R4     |
  |          | Net2     | 5    | R4     |
  |          | Net3     | 2    | R4     |
  |          |          |      |        |
  | R6更新后 | Net1     | 4    | R4     |
  |          | Net2     | 5    | R4     |
  |          | Net3     | 2    | R4     |

- 特点：好消息传得快，坏消息传的慢（可能会死循环到跳数 16 不可达）

##### 4.12、开放最短路径优先 OSPF 协议

> 使用分布式的链路状态协议
>
> OSPF 分组用 IP 数据报传送

- 开放：OSPF 协议不受某一家厂商控制，是公开发表
- 最短路径优先：使用 Dijkstra 提出的最短路径算法 SPF
- 特点：
  - 使用洪泛法向自治系统内所有路由器发送信息，即每个路由器通过输出端口向所有相邻路由器发送信息，依次发送（广播），最终整个区域内所有路由器都得到该信息的一个副本
  - 发送的信息是与本路由器相邻的所有路由器的链路状态（本路由器和哪些路由器相邻，及该链路的费用、距离、时延、带宽等）
  - 只当链路状态发生变化，路由器才向所有路由器洪泛发送此信息
  - 最后所有路由器都能建立一个链路状态数据库（全网拓扑图）
- 链路状态路由算法
  - 每个路由器发现其邻居结点（HELLO 问候分组），了解邻居节点网络地址
  - 设置到其每个邻居的成本度量 metric
  - 构造 DD 数据库描述分组，向邻站给出自己的链路状态数据库中所有链路状态项目的摘要信息
  - 如果 DD 分组中的摘要自己都有，邻站不做处理；如果没有或更新，
    则发送 LSR 链路状态请求分组，请求自己没有的和比自己更新的信息
  - 收到邻站的 LSR 分组后发送 LSU 链路状态更新分组进行更新
  - 更新完毕后邻站返回一个 LSAck 链路状态确认分组进行确认
  - 只要一个路由器链路状态发生变化：
    - 泛洪发送 LSU 链路状态更新分组进行更新
    - 更新后其他站返回一个 LSAck 链路状态确认分组进行确认
    - 使用 Dijkstra 根据自己的链路状态数据库构造到其他节点间的最短路径
- 特点：
  - 每隔 30min 刷新一次数据库中链路状态
  - 由于一个路由器链路状态只涉及与相邻路由器连通状态，与整个互联网规模无直接关系。当互联网规模很大时，OSPF 协议比 RIP 好
  - 不存在坏消息传的慢问题，收敛速度很快

##### 4.13、BGP 协议：应用层协议，借助 TCP

- 与其他 AS 的邻站 BGP 发言人（通常是 BGP 边界路由器）交换信息
- 交换网络可达性信息，即到达某个网络所要经过的一系列 AS
- 发生变化时更新有变化部分
- 交换过程
  - 当 BGP 发言人互换网络可达性信息后，各 BGP 发言人根据采用的策略从收到的路由信息中找出到达各 AS 的较好路由
  - BGP 发言人交换路径向量
- 特点
  - 支持 CIDR，BGP 的路由表包括目的网络前缀、下一跳路由器，及到目的网络经过的各个自治系统序列
  - BGP 刚运行时，其邻站是交换整个的 BGP 路由表，以后只需在发生变化时更新变化部分，节省网络带宽，减少路由器处理开销
- BGP-4 报文
  - OPEN（打开）报文：与相邻另一 BGP 发言人建立关系，认证发送方
  - UPDATE（更新）报文：通告新路径或撤销原路径
  - KEEPALIVE（保活）报文：无 UPDATE 时，周期性证实邻站连通性，作为 OPEN 的确认
  - NOTIFICATION（通知）报文：报告先前报文的差错，用于关闭连接

##### 4.14、三种协议比较

- RIP：分布式的基于距离向量的内部网关路由选择协议，通过广播 UDP 报文交换路由信息
- OSPF：内部网关协议，交换信息量较大，应使报文长度尽量短，不使用传输层协议（UDP、TCP），直接采用 IP
- BGP：外部网关协议，在不同自治系统间交换路由信息，由于网络环境复杂，需保证可靠传输，采用 TCP

|   协议   | RIP                                      | OSPF                               | BGP                                    |
| :------: | :--------------------------------------- | :--------------------------------- | :------------------------------------- |
|   类型   | 内部                                     | 内部                               | 外部                                   |
| 路由算法 | 距离-向量                                | 链路状态                           | 路径-向量                              |
| 传递协议 | UDP                                      | IP                                 | TCP                                    |
| 路径选择 | 跳数最少                                 | 代价最低                           | 较好，非最佳                           |
| 交换结点 | 本结点相邻路由器                         | 网络所有路由器                     | 本结点相邻路由器                       |
| 交换内容 | 当前本路由器知道的全部信息（自己路由表） | 与本路由器相邻的所有路由器链路状态 | 首次：整个路由表<br />非首次：变化部分 |

##### 4.15、IP 数据包传输方式

- 单播：用于发送数据包到单个目的地，每发送一份单播报文都使用一个单播 IP 地址作为目的地址，点对点传输方式
- 广播：发送数据包到同一广播域或子网内所有设备的一种数据传输方式，点对多点传输方式
- 组播（多播）：当网络中某些用户要特定数据时，组播数据发送者仅发送一次数据，借助组播路由协议为组播数据包建立组播分发树，被传递的数据到达距离用户端尽可能近的节点后开始复制和分发，点对多点传输方式
  - 提高数据传送效率，减少主干网出现拥塞可能性。组播组中主机可在同一个物理网络，也可来自不同物理网络（如果有组播路由器支持）
  - IP 组播地址让源设备能将分组发给一组设备。属于多播组的设备将被分配一个组播组 IP 地址（一群共同需求主机的相同标识）
  - 组播地址范围：224.0.0.0~239.255.255.255（D 类地址），一个 D 类地址表示一个组播组，只能用作分组目标地址，源地址总是单播地址
  - 组播数据报不提供可靠交付，应用于 UDP
  - 对组播数据报不产生 ICMP 差错报文
  - 并非所有 D 类地址都可作为组播地址
  - 硬件组播
    - 同单播地址一样，组播 IP 地址也需相应组播 MAC 地址在本地网络中实际传送帧。组播 MAC 地址以十六进制值 01-00-5E 打头，余下的 6 个十六进制位根据 IP 组播组地址最后 23 位转换得到
    - 收到多播数据报的主机，还要在 IP 层利用软件过滤，把不是本主机要接收数据报丢弃
- 网际组管理协议 IGMP：让路由器知道本局域网上是否有主机（进程）参加或退出某个组播组
  - 某主机要加入组播组时，该主机向组播组的组播地址发送一个 IGMP 报文，声明自己要成为该组成员
  - 本地组播路由器收到 lGMP 报文后，利用组播路由选择协议把该组成员关系发给因特网上其他组播路由器
  - 本地组播路由器周期性探询本地局域网上的主机，以便知道其是否还是组播组成员
  - 只要有一个主机对某个组响应，组播路由器就认为该组活跃，如果几次探询后没有一个主机响应，组播路由器就认为本网络上没有此组播组的主机，不再把这组的成员关系发给其他组播路由器
  - 组播路由器知道的成员关系只是所连接局域网中有无组播组成员
- 组播路由选择协议
  - 目的：找出以源主机为根节点的组播转发树
  - 构造树可避免在路由器间兜圈子
  - 不同多播组对应不同多播转发树，同一多播组对不同源点也有不同多播转发树
  - 算法
    - 基于链路状态的路由选择
    - 基于距离-向量的路由选择
    - 协议无关的组播（稀疏/密集）

##### 4.16、移动 IP

> 移动 lP 技术：移动结点（计算机/服务器等）以固定的网络 IP 地址，实现跨越不同网段的漫游功能，保证基于网络 IP 网络权限在漫游过程中不发生任何改变

- 移动结点：具有永久 IP 地址的移动设备
- 归属代理（本地代理）：一个移动结点拥有的“居所”称归属网络，在归属网络中代表移动节点执行移动管理功能的实体
- 外部代理（外地代理）：在外部网络中帮助移动节点完成移动管理功能的实体
- 永久地址（归属地址/主地址）：移动站点在归属网络中的原始地址
- 转交地址（辅地址）移动站点在外部网络使用的临时地址

##### 4.17、设备

- 路由器：具有多输入端口和多输出端口的专用计算机，任务是转发分组
- 根据所选定的路由选择协议构造出路由表，经常或定期和相邻路由器交换路由信息，不断更新维护路由表
- 交换结构：根据转发表（路由表得来）对分组进行转发
- 若收到 RIP/OSPF 分组等，把分组送往路由选择处理机，若收到数据分组，查找转发表并输出

![计网_路由](图片.assets\计网_路由.png)

- 输入端口

  ![计网_路由](图片.assets\计网_路由输入.png)

- 输出端口

  - 若路由器处理分组速率赶不上分组进入队列速率，队列存储空间最终必减少到零，使后面进入队列的分组被丢弃

  ![计网_路由输出](图片.assets\计网_路由输出.png)

- 三层设备区别
  - 路由器可互联两不同网络层协议的网段
  - 网桥可互联两物理层和链路层不同的网段
  - 集线器不能互联两个物理层不同的网段

#### 5、传输层

##### 5.1、功能:

- 提供进程间逻辑通信

  - 网络层提供主机间逻辑通信

- 复用、分用

  - 复用：应用层所有应用进程都可通过传输层再传输到网络层

  - 分用：传输层从网络层收到数据后交付指明的应用进程

  - 逻辑端口/软件端口：端口是传输层的 SAP，标识主机应用进程

    - 服务端

      > 熟知端口号：给 TCP/IP 最重要一些应用程序，让所有用户都知道，0~1023
      >
      > 登记端口号：为没有熟知端口号的应用程序使用，1024~49151

    - 客户端：仅在客户进程运行时动态选择，49152~65535

  | 应用程序 | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP |
  | :------: | :--: | :----: | :--: | :--: | :--: | :--: | :--: |
  |  端口号  |  21  |   23   |  25  |  53  |  69  |  80  | 161  |

  - 套接字：唯一标识网络中一个主机及其一个进程，Socket =（主机 IP 地址，端口号）

- 对收到的报文进行差错检测

- 协议

  - 面向连接的传输控制协议 TCP：

    - 传送数据前必须建立连接，数据传送结束后要释放连接

    - 不提供广播或多播服务

    - 由于 TCP 提供可靠的面向连接的传输服务，不可避免增加许多开销：

      > 确认
      >
      > 流量控制
      >
      > 计时器
      >
      > 连接管理等

    - 可靠，面向连接，时延大，适用大文件

  - 无连接的用户数据报协议 UDP：

    - 传送数据前不需建立连接，收到 UDP 报文后不需给任何确认
    - 不可靠，无连接，时延小，适用小文件

##### 5.2、UDP

- 只在 IP 数据报服务上增加复用分用、差错检测功能

- 特点

  - 无连接，减少开销和发送数据前的时延
  - 使用最大努力交付（不保证可靠交付）
  - 面向报文，适合一次性传输少量数据的网络应用
  - 无拥塞控制，适合很多实时应用
  - 首部开销小，8B，TCP 20B
  - 应用层给 UDP 多长的报文，UDP 照样发送（一次发一个完整报文），减少网络层压力

- 首部

  - 分用时找不到对应的目的端口号就丢弃报文，并发送 ICMP “端口不可达”差错报告报文

  ![计网_UDP首部](图片.assets\计网_UDP首部.png)

- 校验

  - 伪首部：只在计算检验和时出现，不向下传送，不向上递交
    - 源 IP 地址 + 目的 IP 地址 + 0 + 17（IP 数据报首部协议字段） + UDP 长度
  - 校验和：伪首部+首部+数据部分，采用二进制反码求和
  - 检验结果全为 1 无差错，否则丢弃数据报、交给应用层附上出错警告

##### 5.3、TCP

- 特点

  - 面向连接（虚连接）的传输层协议
  - 每条 TCP 连接只有两个端点（点对点）
  - 提供可靠交付的服务，无差错、不丢失、不重复、按序到达
  - 提供全双工通信
    - 发送缓存：准备发送的数据 & 已发送但未收到确认的数据
    - 接收缓存：按序到达但未被接受应用程序读取的数据 & 不按序到达的数据
  - 面向字节流：把应用程序交下来的数据看成一连串无结构字节流
    - 流：流入到进程或从进程流出的字节序列

- 首部

  - 序号：一个 TCP 连接中传送字节流中的每个字节都按顺序编号，本字段表示本报文段发送数据的第一个字节的序号
  - 确认号：期望收到对方下一报文段的第一个数据字节的序号，若确认号为 N，表示到序号 N-1 的所有数据都已正确收到
  - 数据偏移（首部长度）：TCP 报文段数据起始处距 TCP 报文段起始处多远，单位 4B，1 个数值 4B
  - 控制位
    - 紧急位 URG：为 1 时，表示此报文段中有紧急数据，高优先级，不用在缓存排队，配合紧急指针字段使用
    - 确认位 ACK：为 1 时确认号有效，连接建立后所有传送的报文段都把 ACK 置 1
    - 推送位 PSH：为 1 时接收方尽快交付接收应用进程，不再等缓存填满再向上交付
    - 复位 RST：为 1 时表示 TCP 连接中出现严重差错，必须释放连接再重新建立
    - 同步位 SYN：为 1 时表示一个连接请求 / 连接接受报文
    - 终止位 FIN：为 1 时表示报文段发送方数据已发完，要求释放连接
  - 窗口：发送本报文段一方的接收窗口（现在允许对方发送的数据量）
  - 检验和：检验首部 + 数据，检验时加上 12B 伪首部，第四个字段为 6
  - 紧急指针：URG=1 时有意义，指出本报文段中紧急数据的字节数
  - 选项：最大报文段长度 MSS、窗口扩大、时间戳、选择确认等

  ![计网_TCP首部](图片.assets\计网_TCP首部.jpg)

- 连接管理

  - 连接建立

    - 采用客户服务器方式，主动发起连接建立的应用进程是客户，被动等待连接建立的应用进程是服务器

    - 三次握手

      > 客户端发送连接请求报文段，无应用层数据，SYN=1，seq=x（随机）
      >
      > 服务器端为该 TCP 连接分配缓存和变量，向客户端返回确认报文段，允许连接，无应用层数据，SYN=1，ACK=1，seq=y（随机），ack=x+1
      >
      > 客户端为 TCP 连接分配缓存和变量，向服务器端返回确认的确认，可携带数据，SYN=0，ACK=1，seq=x+1，ack=y+1

      ![计网_三次握手](图片.assets\计网_三次握手.jpg)

    - SYN 洪泛攻击：攻击者发送 TCP SYN，三次握手中第一个数据包，当服务器返回 ACK 后，攻击者不对其确认，该 TCP 连接处于挂起状态（半连接状态），服务器收不到再确认时会重复发送 ACK 给攻击者，浪费服务器资源，攻击者对服务器发送大量该 TCP 连接，每个都没完成三次握手，在服务器上，该 TCP 连接因为挂起状态消耗 CPU 和内存，可能死机，无法为正常用户提供服务

  - 数据传送

  - 连接释放

    - 客户端发送连接释放报文段，停止发送数据，主动关闭 TCP 连接，FIN=1，seq=u
    - 服务器端回送一个确认报文段，客户到服务器方向的连接释放（半关闭状态），ACK=1，seq=v，ack=u+1
    - 服务器端发完数据，发出连接释放报文段，主动关团 TCP 连接，FIN=1，ACK=1，seq=w，ack=u+1
    - 客户端回送一个确认报文段，等待计时器设置的 2MSL（最长报文段寿命），连接彻底关闭，ACK=1，seq=u+1，ack=w+1

    ​	![计网_四次挥手](图片.assets\计网_四次挥手.jpg)

- 可靠传输

  - 校验：与 UDP 一样增加伪首部

  - 序号：一字节占一序号，序号字段指报文段第一个字节的序号

  - 确认：默认使用累计确认

  - 重传：确认重传不分家，TCP 发送方在规定的时间内没有收到确认要重传已发送报文段

    - 重传时间：采用自适应算法，动态改变重传时间 RTTs（加权平均往返时间）

    - 冗余 ACK（冗余确认）：每当比期望序号大的失序报文段到达时发送一个冗余 ACK，指明下一期待字节序号

      > 快速重传：发送方收到 3 个对于报文段 x 的冗余 ACK，认为该报文段丢失，重传该报文段

- 流量控制：滑动窗口机制

  - 接收方根据自己接收缓存大小，动态调整发送方发送窗口大小，接收窗口 rwnd（接收方设置确认报文段窗口字段将 rwnd 通知给发送方），发送方发送窗口取接收窗口 rwnd 和拥塞窗口 cwnd 最小值
  - 为每个连接设有一个持续计时器，只要 TCP 连接一方收到对方的零窗口通知，就启动持续计时器
  - 若持续计时器设置时间到期，发送一个零窗口探测报文段，接收方收到探测报文段时给出现在窗口值
  - 若窗口仍然是 0，发送方重新设置持续计时器

- 拥塞控制

  - 假定

    - 数据单方向传送，另一方向只传送确认

    - 接收方总有足够大缓存空间，发送窗口取决于拥塞程度

      > 发送窗口 = Min(接收窗口 rwnd, 拥塞窗口 cwnd)
      >
      > 接收窗口：接收方根据接受缓存设置值，告知给发送方，反映接收方容量
      >
      > 拥塞窗口：发送方根据自己估算的网络拥塞程度设置的窗口值，反映网络当前容量

  - 慢开始 & 拥塞避免

    - 一个传输轮次：发送一批报文段并收到其确认时间，
    - 一个往返时延 RTT：开始发送一批拥塞窗口内的报文段到开始发送下一批拥塞窗口内的报文段的时间

    ![计网_慢开始_拥塞避免](图片.assets\计网_慢开始_拥塞避免.jpg)

  - 快重传 & 快恢复

    ![计网_快重传_快恢复](图片.assets\计网_快重传_快恢复.jpg)

#### 6、应用层

##### 6.1、概述

- 协议定义：

  - 应用进程交换报文类型，请求 & 响应
  - 各报文类型语法，如报文中各个字段及详细描述
  - 字段语义
  - 进程何时、如何发送报文、对报文响应的规则

- 功能：

  - 文件传输、访问 & 管理
  - 电子邮件
  - 虚拟终端
  - 查询服务和远程作业登录

- 网络应用模型

  - 客户/服务器模型（Client/Server）

    > 应用：Web、文件传输 FTP、远程登录、电子邮件

    - 服务器：提供计算服务的设备

      > 永久提供服务
      >
      > 永久性访问地址/域名

    - 客户机：请求计算服务的主机

      > 与服务器通信，使用服务器提供的服务
      >
      > 间歇性接入网络
      >
      > 可能使用动态 IP 地址
      >
      > 不与其他客户机直接通信

  - P2P 模型（Peer-to-Peer）

    - 不存在永远在线的服务器
    - 每个主机既可以提供服务，也可请求服务
    - 任意端系统/节点间可直接通讯
    - 节点间歇性接入网络
    - 节点可能改变 IP 地址
    - 可扩展性好
    - 网络健壮性强

##### 6.2、DNS 系统

- 域名

  - 顶级域名
    - 国家顶级域名：cn、us、uk
    - 通用顶级域名：com、net、org、gov、int、aero、museum、travel
    - 基础结构域名/反向域名：arpa
  - 二级域名
    - 类别域名：ac、com、edu、gov、mil、net、org
    - 行政区域名：用于我国各省、自治区、直辖市，bj、js
  - 三级域名、四级域名

- 域名服务器（从上到下查询）

  - 本地域名服务器：当一个主机发出 DNS 查询请求时，该请求报文发给本地域名服务器
  - 根域名服务器
  - 顶级域名服务器（管理该顶级域名服务器注册的所有二级域名）
  - 权限域名服务器（负责一个区的域名服务器）

- 域名解析

  - 递归查询
  - 迭代查询

  ![计网_域名解析](图片.assets\计网_域名解析.jpg)



##### 6.3、文件传送协议 FTP

> 提供不同种类主机系统（硬、软件体系等都可不同）间的文件传输能力

- 简单文件传送协议 TFTP
- 服务器和用户端
  - 基于客户/服务器（C/S）的协议
  - 用户通过一个客户机程序连接至在远程计算机上运行的服务器程序，依照 FTP 协议提供服务，进行文件传送的计算机是 FTP 服务器
  - 连接 FTP 服务器，遵循 FTP 协议与服务器传送文件的电脑是 FTP 客户端
- 工作原理
  - 登陆：ftp 地址
    - 用户名 & 密码
    - 匿名登陆：互连网中很大一部分 FTP 服务器称为“匿名” FTP 服务器，目的是向公众提供文件拷贝服务，不要求用户事先在该服务器登记注册，不用取得 FTP 服务器授权，匿名文件传输能使用户与远程主机建立连接并以匿名身份从远程主机上拷贝文件
  - 基于 TCP
    - 传请求：TCP 控制连接端口 21，控制连接始终保持
    - 传文件：TCP 数据连接端口 20，数据连接保持一会
- 传输模式
  - 文本模式：ASCII 模式，以文本序列传输数据
  - 二进制模式：Binary 模式，以二进制序列传输数据

##### 6.4、电子邮件

- 组成结构
  - 发件人用户代理：
    - 撰写、显示、处理、通信
  - 发送方邮件服务器：C/S
    - 发送 & 接收邮件
    - 向发件人报告邮件传送结果
  - 协议：TCP 连接
    - 发送：SMTP
    - 接收：POP3、IMAP

![计网_邮件](图片.assets\计网_邮件.jpg)

- 简单邮件传送协议 SMTP

  - 规定在两个相互通信的 SMTP 进程间如何交换信息

  - 负责发送邮件的 SMTP 进程是 SMTP 客户，接收邮件的进程是 SMTP 服务器

  - 规定 14 条命令（几个字母）和 21 种应答信息（三位数字代码+简单文字说明）

  - 通信

    - 建立连接：发送方 -- 发送方邮件服务器 --220 Service ready、HELLO 命令-- 接收方邮件服务器

      > SMTP 服务器若有能力接收邮件，回答 250 OK
      >
      > 否则回答 421 Service not available

    - 邮件发送

    - 连接释放

      > 邮件发完，SMTP 客户发送 QUIT 命令，SMTP 服务器返回 221，表示同意释放 TCP 连接

  - 缺点

    - 不能传送可执行文件或其他二进制对象
    - 仅限传送 7 位 ASCII 码，不能传送非英语
    - SMTP 服务器会拒绝超过一定长度的邮件

  - 通用因特网邮件扩充 MIME：使电子邮件系统可支持声音、图像、视频、多种国家语言等

- 邮局协议 POP3：TCP 连接，端口 110，C/S

  - 下载并保留（服务器）
  - 下载并删除

- 网际报文存取协议 IMAP：比 POP 协议复杂

  - 当用户 pc 上的 IMAP 客户程序打开 IMAP 服务器邮箱时，用户可看到邮箱首部，若用户需打开某邮件，该邮件才上传到用户计算机上
  - 可让用户在不同地方使用不同计算机随时上网阅读处理邮件，允许只读取邮件中某一部分（先看正文，有 WiFi 时再下载附件）

##### 6.5、万维网 & HTTP

> 万维网：一个大规模的、联机式的信息储藏所/资料空间，是无数个网络站点和网页的集合

- 统一资源定位符 URL：唯一标识资源（文字、视频、音频等），不区分大小写
  - 形式：<协议>://<主机>:<端口>/<路径>

> HTTP：定义浏览器（万维网客户进程）怎样向万维网服务器请求万维网文档，及服务器怎样把文档传送浏览器，无状态

- 浏览页面
  - 浏览器分析 URL
  - 浏览器向 DNS 请求解析 IP 地址
  - DNS 解析出 IP 地址
  - 浏览器与服务器建立 TCP 连接
  - 浏览器发出取文件命令
  - 服务器响应
  - 释放 TCP 连接
  - 浏览器显示
- Cookie：存储在用户主机中的文本文件，记录一段时间内某用户（使用识别码识别，如 123456）的访问记录
- 连接：TCP，HTTP 本身无连接
  - 持久连接（Keep-alive）
    - 流水线
    - 非流水线
  - 非持久连接（close）
- 报文结构：HTTP 报文面向文本，报文中每个字段都是一些 ASCIl 码串
  - 请求报文
  - 响应报文
- 状态码
  - 1xx：通知信息，如请求收到或正在处理
  - 2xx：成功、如接受或知道
  - 3xx：重定向，如完成请求还须采取进一步行动
  - 4xx：客户差错，如请求中有错误语法或不能完成
  - 5xx：服务器差错，如服务器失效无法完成请求



